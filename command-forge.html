<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TrialForge | Mobile Command</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #c0392b;
            --bg: #f4f7f6;
            --card-bg: #ffffff;
        }
        
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--primary); padding-bottom: 20px; }
        
        /* Layout Wrapper */
        .wrapper { display: flex; min-height: 100vh; flex-direction: row; }
        
        /* Desktop Sidebar (Default) */
        .sidebar { width: 250px; background: var(--primary); color: white; padding: 20px; flex-shrink: 0; display: flex; flex-direction: column; }
        .logo { font-size: 1.5rem; font-weight: bold; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .nav-item { padding: 15px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; opacity: 0.7; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        .nav-item:hover { opacity: 1; background: rgba(255,255,255,0.1); }
        .nav-item.active { opacity: 1; background: var(--accent); font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        
        /* Main Content */
        .main { flex-grow: 1; padding: 30px; overflow-y: auto; height: 100vh; }
        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; }
        .badge { background: var(--accent); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        
        h1 { font-size: 1.8rem; margin-bottom: 5px; color: var(--primary); }
        #page-subtitle { font-size: 0.95rem; opacity: 0.7; }

        /* Context Banner */
        .context-banner { background: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid rgba(0,0,0,0.05); display: flex; gap: 15px; align-items: start; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        .context-icon { font-size: 1.8rem; color: var(--accent); background: rgba(52, 152, 219, 0.1); width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 12px; flex-shrink: 0; }
        
        /* KPI Grid */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .kpi-card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border-top: 4px solid var(--accent); position: relative; overflow: hidden; }
        .kpi-value { font-size: 2rem; font-weight: 800; margin: 10px 0 5px; letter-spacing: -1px; }
        .kpi-label { font-size: 0.85rem; opacity: 0.6; font-weight: 600; text-transform: uppercase; }
        
        /* Content Grid */
        .content-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .chart-card, .list-card { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        
        h2 { margin-bottom: 20px; font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; justify-content: space-between; }
        
        .list-item { padding: 15px 0; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .list-item:last-child { border-bottom: none; }
        .risk-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .dot-red { background: var(--danger); box-shadow: 0 0 0 3px rgba(192, 57, 43, 0.2); }
        .dot-yellow { background: var(--warning); box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.2); }

        /* Action Button */
        #action-btn { 
            width: 100%; padding: 15px; margin-top: 15px; background: var(--accent); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: transform 0.2s; 
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        #action-btn:active { transform: scale(0.98); }

        /* Dynamic Theme Colors */
        .mode-patient { --accent: #2980b9; }
        .mode-recruit { --accent: #8e44ad; }
        .mode-staff { --accent: #d35400; }

        /* ================= MOBILE OPTIMIZATION ================= */
        @media (max-width: 900px) {
            .wrapper { flex-direction: column; }
            
            /* Turn Sidebar into Top Nav */
            .sidebar { 
                width: 100%; 
                padding: 10px 15px; 
                flex-direction: row; 
                align-items: center; 
                gap: 15px; 
                position: sticky; 
                top: 0; 
                z-index: 100;
                overflow-x: auto; 
                white-space: nowrap;
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            }
            
            .logo { 
                margin-bottom: 0; 
                font-size: 1.2rem; 
                margin-right: 15px; 
                padding-right: 15px;
                border-right: 1px solid rgba(255,255,255,0.2);
            }
            
            .nav-item { 
                margin-bottom: 0; 
                padding: 8px 15px; 
                font-size: 0.9rem; 
                flex-shrink: 0;
            }

            .main { 
                padding: 20px 15px; 
                height: auto; 
                overflow-y: visible;
            }

            h1 { font-size: 1.5rem; }
            
            /* Stack Context Banner */
            .context-banner { flex-direction: row; align-items: flex-start; padding: 15px; }
            .context-icon { width: 40px; height: 40px; font-size: 1.4rem; }
            #banner-title { font-size: 1rem; margin-bottom: 5px; }
            #banner-desc { font-size: 0.85rem; line-height: 1.4; }

            /* Mobile Grid: 2x2 for KPIs */
            .kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 15px; }
            .kpi-card { padding: 15px; }
            .kpi-value { font-size: 1.6rem; }
            
            /* Stack Content vertically */
            .content-grid { grid-template-columns: 1fr; gap: 20px; }
            
            .chart-card, .list-card { padding: 20px; }
            
            /* Hide the footer version text in sidebar */
            .sidebar div:last-child { display: none; }
        }
    </style>
</head>
<body class="mode-patient"> 

<div class="wrapper">
    <div class="sidebar">
        <div class="logo"><i class="fas fa-cubes"></i> Forge</div>
        <div class="nav-item active" onclick="switchMode('patient')">
            <i class="fas fa-user-injured"></i> Retention
        </div>
        <div class="nav-item" onclick="switchMode('recruit')">
            <i class="fas fa-filter"></i> Recruitment
        </div>
        <div class="nav-item" onclick="switchMode('staff')">
            <i class="fas fa-user-nurse"></i> Staff
        </div>
        <div style="margin-top: auto; opacity: 0.5; font-size: 0.7rem;">v2.4</div>
    </div>

    <div class="main">
        <div class="header">
            <div>
                <h1 id="page-title">Retention Module</h1>
                <p id="page-subtitle">Monitoring active cohort engagement</p>
            </div>
            <span class="badge">Live</span>
        </div>

        <div class="context-banner">
            <div class="context-icon" id="banner-icon"><i class="fas fa-user-injured"></i></div>
            <div>
                <h3 id="banner-title">The "Motivation Half-Life"</h3>
                <p id="banner-desc">Signal decay below 40% triggers immediate intervention alerts.</p>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card" style="border-top-color: var(--success)">
                <div class="kpi-label" id="kpi-1-label">Active</div>
                <div class="kpi-value" id="kpi-1-value">842</div>
            </div>
            <div class="kpi-card" style="border-top-color: var(--accent)">
                <div class="kpi-label" id="kpi-2-label">Engagement</div>
                <div class="kpi-value" id="kpi-2-value">76%</div>
            </div>
            <div class="kpi-card" style="border-top-color: var(--warning)">
                <div class="kpi-label" id="kpi-3-label">At Risk</div>
                <div class="kpi-value" id="kpi-3-value">48</div>
            </div>
            <div class="kpi-card" style="border-top-color: var(--danger)">
                <div class="kpi-label" id="kpi-4-label">Loss (30d)</div>
                <div class="kpi-value" id="kpi-4-value">12</div>
            </div>
        </div>

        <div class="content-grid">
            <div class="chart-card">
                <h2 id="chart-title">Decay Forecast</h2>
                <div id="main-chart" style="height: 300px;"></div>
            </div>
            
            <div class="list-card">
                <h2 id="list-title">Action Required</h2>
                <div id="risk-list">
                    </div>
                <button id="action-btn">
                    <i class="fas fa-bolt"></i> <span id="btn-text">Deploy Interventions</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // DATA CONFIGURATIONS
    const CONFIG = {
        patient: {
            theme: '#2980b9',
            title: 'Patient Retention',
            subtitle: 'Cohort engagement signals',
            banner: { title: 'Motivation Half-Life', desc: 'We model patient adherence as a decaying signal. Dropout immenent below 40%.', icon: 'fa-user-injured' },
            kpis: [
                {label: 'Active', val: '842', color: '#27ae60'},
                {label: 'Engagement', val: '76%', color: '#2980b9'},
                {label: 'At Risk', val: '48', color: '#f39c12'},
                {label: 'Loss (30d)', val: '12', color: '#c0392b'}
            ],
            chartTitle: 'Decay Forecast',
            listTitle: 'Risk Alerts',
            items: [
                {name: 'Subj-104 (Missed Visit)', risk: 'High'},
                {name: 'Subj-099 (No Logs)', risk: 'High'},
                {name: 'Subj-201 (AE Report)', risk: 'Med'},
                {name: 'Subj-118 (Travel)', risk: 'Med'}
            ],
            btnText: 'Deploy Protocol'
        },
        recruit: {
            theme: '#8e44ad',
            title: 'Recruitment AI',
            subtitle: 'Lead interest velocity',
            banner: { title: 'The "Cool-Down"', desc: 'Interest decays 50% every 4 hours. We predict "ghosting" before it happens.', icon: 'fa-filter' },
            kpis: [
                {label: 'Funnel', val: '1,204', color: '#27ae60'},
                {label: 'Conversion', val: '3.4%', color: '#8e44ad'},
                {label: 'Ghost Risk', val: '450', color: '#f39c12'},
                {label: 'Lost Opps', val: '89', color: '#c0392b'}
            ],
            chartTitle: 'Interest Decay',
            listTitle: 'Cold Leads',
            items: [
                {name: 'Lead #4092 (No Reply)', risk: 'High'},
                {name: 'Lead #3321 (Incomplete)', risk: 'High'},
                {name: 'Lead #5510 (Sched)', risk: 'Med'},
                {name: 'Lead #1102 (Review)', risk: 'Med'}
            ],
            btnText: 'SMS Re-engage'
        },
        staff: {
            theme: '#d35400',
            title: 'Staff Stability',
            subtitle: 'Burnout & Turnover Prediction',
            banner: { title: 'Burnout Threshold', desc: 'Predicting resignation risks by monitoring workload vs. support ratios.', icon: 'fa-user-nurse' },
            kpis: [
                {label: 'Sites', val: '14', color: '#27ae60'},
                {label: 'Workload', val: '110%', color: '#d35400'},
                {label: 'Overburden', val: '6', color: '#f39c12'},
                {label: 'Resign Risk', val: '2', color: '#c0392b'}
            ],
            chartTitle: 'Resilience Curve',
            listTitle: 'Burnout Risk',
            items: [
                {name: 'Site 04: Sarah J.', risk: 'High'},
                {name: 'Site 12: Mike R.', risk: 'High'},
                {name: 'Site 01: Team A', risk: 'Med'},
                {name: 'Site 08: Vacancy', risk: 'Med'}
            ],
            btnText: 'Request Support'
        }
    };

    let currentMode = 'patient';

    function switchMode(mode) {
        currentMode = mode;
        const data = CONFIG[mode];
        
        // Update CSS variables for theme
        document.body.className = `mode-${mode}`;
        
        // Update Sidebar UI
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');

        // Update Text Content
        document.getElementById('page-title').innerText = data.title;
        document.getElementById('page-subtitle').innerText = data.subtitle;
        document.getElementById('banner-title').innerText = data.banner.title;
        document.getElementById('banner-desc').innerText = data.banner.desc;
        document.getElementById('banner-icon').innerHTML = `<i class="fas ${data.banner.icon}"></i>`;
        
        // Update KPIs
        for(let i=0; i<4; i++) {
            document.getElementById(`kpi-${i+1}-label`).innerText = data.kpis[i].label;
            document.getElementById(`kpi-${i+1}-value`).innerText = data.kpis[i].val;
            document.querySelectorAll('.kpi-card')[i].style.borderTopColor = data.kpis[i].color;
        }

        // Update List
        document.getElementById('list-title').innerText = data.listTitle;
        const listContainer = document.getElementById('risk-list');
        listContainer.innerHTML = '';
        data.items.forEach(item => {
            const color = item.risk === 'High' ? 'dot-red' : 'dot-yellow';
            listContainer.innerHTML += `
                <div class="list-item">
                    <span style="font-weight:500"><span class="risk-dot ${color}"></span> ${item.name}</span>
                    <span style="font-size:0.75rem; opacity:0.6; text-transform:uppercase; font-weight:700">${item.risk}</span>
                </div>`;
        });
        document.getElementById('btn-text').innerText = data.btnText;
        document.getElementById('action-btn').style.background = data.theme;

        // Update Chart
        document.getElementById('chart-title').innerText = data.chartTitle;
        renderChart(mode);
    }

    function renderChart(mode) {
        const data = CONFIG[mode];
        const x = [0, 1, 2, 3, 4, 5, 6];
        let y_decay = [];
        let y_stable = [];
        
        if (mode === 'patient') {
             y_decay = [100, 90, 81, 72, 65, 50, 40];
             y_stable = [100, 98, 96, 95, 93, 91, 90];
        } else if (mode === 'recruit') {
            y_decay = [100, 60, 30, 15, 10, 5, 2];
            y_stable = [100, 95, 85, 80, 75, 70, 65];
        } else {
            y_decay = [100, 95, 90, 80, 60, 40, 20];
            y_stable = [100, 100, 98, 97, 96, 95, 95];
        }

        const trace1 = {
            x: x, y: y_decay, 
            mode: 'lines', name: 'Predicted',
            line: {color: '#c0392b', dash: 'dash'}
        };

        const trace2 = {
            x: x, y: y_stable, 
            mode: 'lines', name: 'Intervention',
            line: {color: data.theme, width: 3}
        };

        const layout = {
            margin: {t:20, r:10, l:30, b:30},
            showlegend: true,
            legend: {orientation: 'h', y: -0.3},
            yaxis: {range: [0, 110]},
            dragmode: false,
            autosize: true
        };
        
        const config = {responsive: true, displayModeBar: false};

        Plotly.newPlot('main-chart', [trace1, trace2], layout, config);
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.nav-item')[0].classList.add('active');
        renderChart('patient');
        
        // Initial list load
        const data = CONFIG.patient;
        const listContainer = document.getElementById('risk-list');
        listContainer.innerHTML = '';
        data.items.forEach(item => {
            const color = item.risk === 'High' ? 'dot-red' : 'dot-yellow';
            listContainer.innerHTML += `
                <div class="list-item">
                    <span style="font-weight:500"><span class="risk-dot ${color}"></span> ${item.name}</span>
                    <span style="font-size:0.75rem; opacity:0.6; text-transform:uppercase; font-weight:700">${item.risk}</span>
                </div>`;
        });
    });

</script>
</body>
</html>
